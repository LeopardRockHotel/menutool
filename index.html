<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leopard Rock Menu Selector Tool</title>
  
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@300;400;600&display=swap"
    rel="stylesheet"
  >
  
  <!-- Choices.js CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
  >
  
  <style>
    /* ================= Global Spacing Settings ================= */
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #eef2f5;
      margin: 0; /* Overall page margin */
      padding: 0; /* Overall page padding */
      color: #333;
      line-height: 1.6; /* Global line spacing (adjust for text readability) */
    }
    .container {
      max-width: 900px;
      margin: 50px auto; /* Outer margin: top-bottom=50px, auto left-right */
      padding: 30px;    /* Inner padding for container */
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    /* ================= Progress Bar Spacing ================= */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px; /* Space below progress bar */
    }
    .progress-bar .step {
      width: 40px;
      height: 40px;
      background: #ddd;
      border-radius: 50%;
      line-height: 40px; /* Centers the number vertically */
      text-align: center;
      font-weight: bold;
      color: #fff;
    }
    .progress-bar .step.active {
      background: #007bff;
    }

    /* ================= Heading Spacing ================= */
    h1 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.8rem;
      text-align: center;
      color: #333;
      margin: 30px 0; /* Top and bottom margin for h1 */
    }
    h2 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.4rem;
      color: #333;
      margin-bottom: 20px; /* Space below h2 */
    }
    h3 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.6rem;
      color: #333;
      margin-bottom: 15px; /* Space below h3 */
    }

    /* ================= Fieldset & Legend Spacing ================= */
    fieldset {
      border: none;
      padding: 0; /* Remove default padding */
      margin: 0 0 30px; /* Space below each fieldset */
    }
    legend {
      font-size: 1.3rem;
      margin-bottom: 10px; /* Space below legend text */
      color: #007bff;
      font-weight: bold;
    }

    /* ================= Form Element Spacing ================= */
    .menu-section {
      margin-bottom: 30px; /* Space between different form sections */
    }
    label {
      display: block;
      margin: 12px 0 6px; /* Top, right/left, and bottom margins for labels */
      font-weight: 500;
    }
    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px; /* Inner padding for form elements */
      margin-bottom: 12px; /* Space below each input element */
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    /* ================= Button Spacing ================= */
    button {
      padding: 14px 28px; /* Vertical and horizontal padding for buttons */
      font-size: 1rem;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin-left: 10px; /* Space to the left of each button */
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      transform: translateY(-2px); /* Slight lift on hover */
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px; /* Space above navigation buttons */
      flex-wrap: wrap;
    }
    .navigation button {
      margin-top: 10px; /* Space above each navigation button if wrapping */
    }

    /* ================= Page Visibility ================= */
    .hidden { display: none; }
    .page { display: none; }
    .page:not(.hidden) { display: block; }

    /* ================= Preview Pane Spacing ================= */
    #previewPane {
      background-color: #f7f7f7;
      border: 1px solid #ccc;
      padding: 15px; /* Inner padding for preview pane */
      margin-top: 20px; /* Space above preview pane */
      max-height: 400px;
      overflow-y: auto;
      font-family: "Courier New", monospace;
      font-size: 0.9rem;
      color: #444;
    }
    #previewPane p {
      margin: 1em 0; /* Margin for paragraphs within preview pane */
      font-family: inherit;
      font-size: inherit;
      font-weight: normal;
      text-transform: none;
      text-align: left;
    }
    /* Inline editing styling spacing */
    .editable {
      border-bottom: 1px dashed #007bff;
      padding: 2px; /* Padding around editable text */
    }

    /* ================= Dish Item Spacing in Preview ================= */
    .dish-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px; /* Space between individual dish items */
    }

    /* ================= Logo Spacing ================= */
    .logo {
      display: block;
      margin: 0 auto 20px; /* Center logo; 20px space below */
      max-width: 200px;
      height: auto;
    }

    /* ================= Modal Spacing ================= */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; 
      z-index: 9999; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5); /* Background overlay */
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; /* Modal vertical margin as 10% of viewport, center horizontally */
      padding: 20px;    /* Inner padding for modal */
      border-radius: 8px;
      width: 80%;       /* Modal width */
      max-width: 600px;
      position: relative;
    }
    .modal .closeBtn {
      position: absolute;
      top: 10px;   /* Space from top of modal content */
      right: 15px; /* Space from right edge */
      font-size: 1.4rem;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .modal .closeBtn:hover {
      color: #000;
    }
    #allDishesList p {
      margin: 8px 0; /* Margin for each dish item in modal */
    }
  </style>
</head>
<body>
  <noscript>
    <p style="color: red; text-align: center;">This app requires JavaScript to function. Please enable JavaScript in your browser.</p>
  </noscript>

  <div class="container">
    <!-- Logo -->
    <img src="./logo.png" alt="Leopard Rock Logo" class="logo" id="interfaceLogo">
    
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="step active" data-step="1">1</div>
      <div class="step" data-step="2">2</div>
      <div class="step" data-step="3">3</div>
      <div class="step" data-step="4">4</div>
    </div>

    <h1>Leopard Rock Menu Selector Tool</h1>

    <!-- Page 1: Menu Type Selection -->
    <div id="page1" class="page">
      <fieldset class="menu-section">
        <legend>Select Menu Type:</legend>
        <div style="display: flex; align-items: center; flex-wrap: wrap;">
          <select id="menuType" class="searchable-select">
            <option value="">--Select--</option>
            <option value="3course">3-Course Menu</option>
            <option value="buffet">Buffet - USD$30</option>
            <option value="kiddie">Kiddies' buffet - USD$15</option>
          </select>
          <button id="refreshBtn">Refresh</button>
          <button id="viewAllDishesBtn">View All Dishes</button>
        </div>
      </fieldset>

      <!-- Customize Menu Description Section -->
      <button id="customizeMenuDescBtn">Customize Menu Description</button>
      <div id="customMenuDescContainer" class="hidden" style="margin-top:10px;">
        <label for="customMenuDescInput">Enter Custom Menu Description:</label>
        <textarea id="customMenuDescInput" rows="3" placeholder="e.g. Valentine's Day Menu: A romantic selection of dishes to celebrate love." style="width:100%;"></textarea>
        <button id="saveCustomDescBtn" style="margin-top:5px;">Save Description</button>
      </div>

      <fieldset id="dishCounts" class="menu-section hidden">
        <legend>Enter Dish Counts:</legend>
        <div id="courseCounts">
          <!-- Inputs will change based on menu type selection -->
        </div>
      </fieldset>

      <div class="navigation">
        <div></div> <!-- Empty div for alignment -->
        <button id="toPage2" disabled>Next</button>
        <!-- Random Menu Generator button appears after a menu type is selected -->
        <button id="randomMenuBtn">Random Menu</button>
      </div>
    </div>

    <!-- Page 2: Course Selection -->
    <div id="page2" class="page hidden">
      <h2>Course Selection</h2>
      <div id="courseSelectionArea">
        <!-- Dynamic course selection UI will go here -->
      </div>
      <div class="navigation">
        <button id="backToPage1">Back</button>
        <button id="toPage3" disabled>Next</button>
      </div>
    </div>

    <!-- Page 3: Custom Dish Input -->
    <div id="page3" class="page hidden">
      <fieldset id="customDishContainer" class="menu-section">
        <legend>Custom Dish</legend>
        <label for="customDishCourse">Select Course:</label>
        <select id="customDishCourse" class="searchable-select">
          <option value="">--Select Course--</option>
          <option value="starters">Starter</option>
          <option value="mains">Main</option>
          <option value="desserts">Dessert</option>
          <option value="buffet">Buffet Dish</option>
          <option value="kiddie">Kiddie Dish</option>
        </select>

        <label for="customDishName">Dish Name:</label>
        <input type="text" id="customDishName" placeholder="Enter dish name">

        <label for="customDishDescription">Description:</label>
        <input type="text" id="customDishDescription" placeholder="Enter dish description">

        <button id="addCustomDish" disabled>Add Custom Dish</button>
      </fieldset>
      <div class="navigation">
        <button id="backToPage2">Back</button>
        <div>
          <button id="skipCustomDish">Skip</button>
          <button id="toPage4">Next</button>
        </div>
      </div>
    </div>

    <!-- Page 4: Preview and Download -->
    <div id="page4" class="page hidden">
      <h2>Preview Menu</h2>
      <div id="previewPane"></div>
      <div class="navigation">
        <button id="backToPage3">Back</button>
        <div>
          <button id="backToBeginning">Back to Beginning</button>
          <button id="downloadPdf">Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== MODAL FOR ALL DISHES ======== -->
  <div id="allDishesModal" class="modal">
    <div class="modal-content">
      <span class="closeBtn" id="closeAllDishesModal">&times;</span>
      <h2>All Dishes</h2>
      <div id="allDishesList">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>
  <!-- ====================================== -->

  <!-- Choices.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  
  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Global flag to indicate random generation should occur
      let randomMenuFlag = false;

      // ======== Refresh Button ========
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.addEventListener('click', () => {
        location.reload();
      });

      // ======= DOM Elements =======
      const menuType = document.getElementById('menuType');
      const dishCounts = document.getElementById('dishCounts');
      const courseCounts = document.getElementById('courseCounts');
      const toPage2Button = document.getElementById('toPage2');
      const backToPage1Button = document.getElementById('backToPage1');
      const courseSelectionArea = document.getElementById('courseSelectionArea');
      const toPage3Button = document.getElementById('toPage3');
      const backToPage2Button = document.getElementById('backToPage2');
      const toPage4Button = document.getElementById('toPage4');
      const skipCustomDishButton = document.getElementById('skipCustomDish');
      const previewPane = document.getElementById('previewPane');
      const backToPage3Button = document.getElementById('backToPage3');
      const backToBeginningButton = document.getElementById('backToBeginning');
      const downloadPdfButton = document.getElementById('downloadPdf');
      const randomMenuBtn = document.getElementById('randomMenuBtn'); // Random Menu Generator button

      // For "View All Dishes" modal
      const viewAllDishesBtn = document.getElementById('viewAllDishesBtn');
      const allDishesModal = document.getElementById('allDishesModal');
      const closeAllDishesModal = document.getElementById('closeAllDishesModal');
      const allDishesList = document.getElementById('allDishesList');

      // For custom dish
      const addCustomDishButton = document.getElementById('addCustomDish');
      const customDishCourse = document.getElementById('customDishCourse');
      const customDishName = document.getElementById('customDishName');
      const customDishDescription = document.getElementById('customDishDescription');

      // For custom menu description on Page 1
      const customizeMenuDescBtn = document.getElementById('customizeMenuDescBtn');
      const customMenuDescContainer = document.getElementById('customMenuDescContainer');
      const saveCustomDescBtn = document.getElementById('saveCustomDescBtn');
      const customMenuDescInput = document.getElementById('customMenuDescInput');

      // ======= Data Structures =======
      let selectedDishes = {
        starters: [],
        mains: [],
        desserts: [],
        buffet: [],
        kiddie: []
      };
      let customDishes = []; // each item: { course, name, description }
      let dishesByType = {};
      let customMenuDescription = ""; // For storing custom menu description

      let courseChoiceInstances = {}; // For each course, an array of Choices instances
      let customCourseChoices;       // Single Choices instance for customDishCourse

      // ======= Fetch Dishes Data =======
      fetch('./dishes.json')
        .then(response => {
          if (!response.ok) throw new Error("Dishes JSON file not found.");
          return response.json();
        })
        .then(data => {
          dishesByType = data;
          console.log("Dishes loaded:", dishesByType);

          // Define click behavior for "View All Dishes"
          viewAllDishesBtn.addEventListener('click', () => {
            populateAllDishes();
            openAllDishesModal();
          });
        })
        .catch(error => {
          console.error("Error loading dishes:", error);
          alert("Failed to load dish data. Please try again later.");
        });

      // ======= showPage() Function =======
      function showPage(pageId) {
        document.querySelectorAll('.page').forEach(pg => pg.classList.add('hidden'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.remove('hidden');
        } else {
          console.error(`Page with id ${pageId} not found`);
          return;
        }
        // Update progress bar based on page number
        const stepNumber = pageId.replace('page', '');
        document.querySelectorAll('.progress-bar .step').forEach(step => {
          step.classList.remove('active');
          if (step.dataset.step === stepNumber) {
            step.classList.add('active');
          }
        });
        // If on Page 4, populate the preview
        if (pageId === 'page4') {
          populatePreview();
        }
      }

      // ======= PAGE 1 (Menu Type) =======
      menuType.addEventListener('change', () => {
        const type = menuType.value;
        courseCounts.innerHTML = ''; 
        if (type) {
          dishCounts.classList.remove('hidden');

          if (type === '3course') {
            courseCounts.innerHTML = `
              <label for="numStarters">Number of Starters:</label>
              <input type="number" id="numStarters" min="1" placeholder="Enter number of starters">
              <label for="numMains">Number of Mains:</label>
              <input type="number" id="numMains" min="1" placeholder="Enter number of mains">
              <label for="numDesserts">Number of Desserts:</label>
              <input type="number" id="numDesserts" min="1" placeholder="Enter number of desserts">
            `;
          } else {
            // buffet or kiddie
            courseCounts.innerHTML = `
              <label for="numDishes">Number of Dishes:</label>
              <input type="number" id="numDishes" min="1" placeholder="Enter number of dishes">
            `;
          }
          dishCounts.addEventListener('input', validatePage1Inputs);
          toPage2Button.disabled = true;
        } else {
          dishCounts.classList.add('hidden');
          toPage2Button.disabled = true;
        }
      });

      function validatePage1Inputs() {
        const type = menuType.value;
        let isValid = false;
        if (type === '3course') {
          const numStarters = parseInt(document.getElementById('numStarters')?.value) || 0;
          const numMains = parseInt(document.getElementById('numMains')?.value) || 0;
          const numDesserts = parseInt(document.getElementById('numDesserts')?.value) || 0;
          isValid = (numStarters > 0 || numMains > 0 || numDesserts > 0);
        } else {
          const numDishes = parseInt(document.getElementById('numDishes')?.value) || 0;
          isValid = (numDishes > 0);
        }
        toPage2Button.disabled = !isValid;
      }

      // ===== New: Random Menu Generator Button Event =====
      randomMenuBtn.addEventListener('click', () => {
        if (!menuType.value) {
          alert("Please select a menu type first.");
          return;
        }
        if (menuType.value === '3course') {
          const numStarters = parseInt(document.getElementById('numStarters')?.value) || 0;
          const numMains = parseInt(document.getElementById('numMains')?.value) || 0;
          const numDesserts = parseInt(document.getElementById('numDesserts')?.value) || 0;
          if (numStarters <= 0 || numMains <= 0 || numDesserts <= 0) {
            alert("Please select a valid number of starters, mains, and desserts.");
            return;
          }
        } else {
          const numDishes = parseInt(document.getElementById('numDishes')?.value) || 0;
          if (numDishes <= 0) {
            alert("Please select a valid number of dishes.");
            return;
          }
        }
        // If dish counts are valid, set flag to randomize course selections on Page 2
        randomMenuFlag = true;
        toPage2Button.click();
      });

      toPage2Button.addEventListener('click', () => {
        showPage('page2');
        populateCourseSelection();
        // If random generation is flagged, randomize the course selections
        if (randomMenuFlag) {
          randomizeCourseSelections();
          randomMenuFlag = false; // reset flag
        }
      });

      // ======= Toggle Custom Menu Description =======
      customizeMenuDescBtn.addEventListener('click', () => {
        customMenuDescContainer.classList.toggle('hidden');
      });

      saveCustomDescBtn.addEventListener('click', () => {
        customMenuDescription = customMenuDescInput.value.trim();
        customMenuDescContainer.classList.add('hidden');
        alert("Custom menu description saved!");
      });

      // ======= PAGE 2 (Course Selection) =======
      backToPage1Button.addEventListener('click', () => {
        showPage('page1');
      });

      function validatePage2Selections() {
        const allSelections = Array.from(document.querySelectorAll('.course-select'));
        const allSelected = allSelections.every(sel => sel.value !== '');
        toPage3Button.disabled = !allSelected;
      }

      function populateCourseSelection() {
        courseSelectionArea.innerHTML = '';
        courseChoiceInstances = {};
        const type = menuType.value;
        let startersCount = 0, mainsCount = 0, dessertsCount = 0, otherCount = 0;
        if (type === '3course') {
          startersCount = parseInt(document.getElementById('numStarters').value) || 0;
          mainsCount = parseInt(document.getElementById('numMains').value) || 0;
          dessertsCount = parseInt(document.getElementById('numDesserts').value) || 0;
        } else {
          otherCount = parseInt(document.getElementById('numDishes').value) || 0;
        }
        if (type === '3course') {
          if (startersCount > 0) createCourseSection('Starters', 'starters', startersCount);
          if (mainsCount > 0) createCourseSection('Mains', 'mains', mainsCount);
          if (dessertsCount > 0) createCourseSection('Desserts', 'desserts', dessertsCount);
        } else {
          const title = (type === 'buffet') ? 'Buffet Dishes' : 'Kiddie Dishes';
          createCourseSection(title, type, otherCount);
        }
        initializeCourseSelects();
        validatePage2Selections();
      }

      function createCourseSection(title, courseType, count) {
        courseChoiceInstances[courseType] = [];
        const section = document.createElement('div');
        section.classList.add('menu-section');
        section.innerHTML = `<h3>${title}</h3>`;
        for (let i = 0; i < count; i++) {
          const label = document.createElement('label');
          label.textContent = `${title} ${i + 1}`;
          const select = document.createElement('select');
          select.classList.add('course-select', 'searchable-select');
          select.dataset.courseType = courseType;
          select.dataset.index = i;
          select.innerHTML = '<option value="">--Select--</option>';
          section.appendChild(label);
          section.appendChild(select);
        }
        courseSelectionArea.appendChild(section);
      }

      function initializeCourseSelects() {
        const selects = document.querySelectorAll('.course-select');
        selects.forEach(sel => {
          const courseType = sel.dataset.courseType;
          const index = parseInt(sel.dataset.index);
          const choicesInstance = new Choices(sel, {
            searchEnabled: true,
            itemSelectText: '',
            shouldSort: false
          });
          courseChoiceInstances[courseType][index] = choicesInstance;
          sel.addEventListener('change', () => {
            const selectedDishName = sel.value;
            if (selectedDishName) {
              const dishObj = dishesByType[courseType]?.find(d => d.name === selectedDishName);
              selectedDishes[courseType][index] = dishObj || null;
            } else {
              selectedDishes[courseType][index] = null;
            }
            updateCourseSelects(courseType);
            validatePage2Selections();
          });
        });
        Object.keys(courseChoiceInstances).forEach(ct => updateCourseSelects(ct));
      }

      function updateCourseSelects(courseType) {
        const chosenDishes = selectedDishes[courseType].filter(Boolean);
        courseChoiceInstances[courseType].forEach((choicesInstance, idx) => {
          const currentDish = selectedDishes[courseType][idx];
          const otherChosen = chosenDishes.filter(d => d !== currentDish);
          const availableDishes = dishesByType[courseType]?.filter(d => {
            return !otherChosen.some(ch => ch.name === d.name);
          }) || [];
          const choicesArray = [{ value: '', label: '--Select--' }]
            .concat(availableDishes.map(d => ({ value: d.name, label: d.name })));
          choicesInstance.setChoices(choicesArray, 'value', 'label', true);
          if (currentDish && availableDishes.find(d => d.name === currentDish.name)) {
            choicesInstance.setChoiceByValue(currentDish.name);
          } else {
            selectedDishes[courseType][idx] = null;
          }
        });
      }

      // New function to randomly select a dish for each course select
      function randomizeCourseSelections() {
        Object.keys(courseChoiceInstances).forEach(courseType => {
          let chosenNames = [];
          courseChoiceInstances[courseType].forEach((choicesInstance, idx) => {
            let availableDishes = dishesByType[courseType] || [];
            let filtered = availableDishes.filter(dish => !chosenNames.includes(dish.name));
            if (filtered.length > 0) {
              let randomIndex = Math.floor(Math.random() * filtered.length);
              let selectedDish = filtered[randomIndex];
              selectedDishes[courseType][idx] = selectedDish;
              choicesInstance.setChoiceByValue(selectedDish.name);
              chosenNames.push(selectedDish.name);
            }
          });
          validatePage2Selections();
        });
      }

      toPage3Button.addEventListener('click', () => {
        showPage('page3');
      });

      // ======= PAGE 3 (Custom Dishes) =======
      customCourseChoices = new Choices(customDishCourse, {
        searchEnabled: true,
        itemSelectText: '',
        shouldSort: false
      });

      backToPage2Button.addEventListener('click', () => {
        showPage('page2');
      });

      function validateCustomDish() {
        const course = customDishCourse.value;
        const name = customDishName.value.trim();
        const description = customDishDescription.value.trim();
        const isValid = course && name && description;
        addCustomDishButton.disabled = !isValid;
      }
      [customDishCourse, customDishName, customDishDescription].forEach(inp => {
        inp.addEventListener('input', validateCustomDish);
      });

      addCustomDishButton.addEventListener('click', () => {
        const course = customDishCourse.value;
        const name = customDishName.value.trim();
        const description = customDishDescription.value.trim();
        if (course && name && description) {
          customDishes.push({ course, name, description });
          alert(`Custom dish added: ${name} (${course})`);
          console.log("All custom dishes:", customDishes);
          customDishName.value = '';
          customDishDescription.value = '';
          addCustomDishButton.disabled = true;
          customCourseChoices.setChoiceByValue('');
        }
      });

      skipCustomDishButton.addEventListener('click', () => {
        showPage('page4');
      });
      toPage4Button.addEventListener('click', () => {
        showPage('page4');
      });

      // ======= PAGE 4: Preview & PDF =======
      backToPage3Button.addEventListener('click', () => {
        showPage('page3');
      });
      backToBeginningButton.addEventListener('click', () => {
        selectedDishes = { starters: [], mains: [], desserts: [], buffet: [], kiddie: [] };
        customDishes = [];
        showPage('page1');
        courseCounts.innerHTML = '';
        dishCounts.classList.add('hidden');
        menuType.value = '';
        toPage2Button.disabled = true;
        courseSelectionArea.innerHTML = '';
      });

      function populatePreview() {
        previewPane.innerHTML = '';
        const headingEl = document.createElement('p');
        headingEl.textContent = 'Selected Dishes:';
        previewPane.appendChild(headingEl);
        let menuTypeText = '';
        switch (menuType.value) {
          case '3course':
            menuTypeText = '3-Course Menu';
            break;
          case 'buffet':
            menuTypeText = 'Buffet - USD$30';
            break;
          case 'kiddie':
            menuTypeText = "Kiddies' buffet - USD$15";
            break;
          default:
            menuTypeText = 'No menu type selected';
            break;
        }
        const menuTypeLine = document.createElement('p');
        menuTypeLine.textContent = menuTypeText;
        previewPane.appendChild(menuTypeLine);
        if (menuType.value === 'buffet' || menuType.value === 'kiddie') {
          const extraSpaceDiv = document.createElement('div');
          extraSpaceDiv.style.height = '20px'; /* Extra spacing for buffet/kiddie */
          previewPane.appendChild(extraSpaceDiv);
        }
        Object.keys(selectedDishes).forEach(courseType => {
          const chosenDishes = selectedDishes[courseType].filter(Boolean);
          const customChosen = customDishes.filter(cd => cd.course === courseType);
          if (chosenDishes.length > 0 || customChosen.length > 0) {
            const courseHeading = document.createElement('p');
            courseHeading.textContent = `${courseType.toUpperCase()}:`;
            previewPane.appendChild(courseHeading);
            chosenDishes.forEach((dish, index) => {
              const dishContainer = document.createElement('div');
              dishContainer.classList.add('dish-item');
              const dishText = document.createElement('span');
              dishText.textContent = `- ${dish.name}: `;
              dishContainer.appendChild(dishText);
              const descriptionSpan = document.createElement('span');
              descriptionSpan.textContent = dish.description;
              descriptionSpan.classList.add('editable');
              descriptionSpan.contentEditable = "false";
              dishContainer.appendChild(descriptionSpan);
              const editBtn = document.createElement('button');
              editBtn.textContent = 'Edit';
              editBtn.style.marginLeft = '10px';
              let editing = false;
              editBtn.addEventListener('click', () => {
                if (!editing) {
                  descriptionSpan.contentEditable = "true";
                  descriptionSpan.focus();
                  editBtn.textContent = "Save";
                  editing = true;
                } else {
                  descriptionSpan.contentEditable = "false";
                  dish.description = descriptionSpan.textContent.trim();
                  editBtn.textContent = "Edit";
                  editing = false;
                }
              });
              dishContainer.appendChild(editBtn);
              previewPane.appendChild(dishContainer);
            });
            customChosen.forEach((dish, idx) => {
              const dishContainer = document.createElement('div');
              dishContainer.classList.add('dish-item');
              const dishText = document.createElement('span');
              dishText.textContent = `- ${dish.name}: `;
              dishContainer.appendChild(dishText);
              const descriptionSpan = document.createElement('span');
              descriptionSpan.textContent = dish.description;
              descriptionSpan.classList.add('editable');
              descriptionSpan.contentEditable = "false";
              dishContainer.appendChild(descriptionSpan);
              const editBtn = document.createElement('button');
              editBtn.textContent = 'Edit';
              editBtn.style.marginLeft = '10px';
              let editing = false;
              editBtn.addEventListener('click', () => {
                if (!editing) {
                  descriptionSpan.contentEditable = "true";
                  descriptionSpan.focus();
                  editBtn.textContent = "Save";
                  editing = true;
                } else {
                  descriptionSpan.contentEditable = "false";
                  dish.description = descriptionSpan.textContent.trim();
                  editBtn.textContent = "Edit";
                  editing = false;
                }
              });
              dishContainer.appendChild(editBtn);
              previewPane.appendChild(dishContainer);
            });
          }
        });
      }

      function getMenuInfoText() {
        if (customMenuDescription && customMenuDescription !== "") {
          return customMenuDescription;
        }
        switch (menuType.value) {
          case '3course':
            return `Table d’hôte
3 courses - US $30
2 courses (starter/main or main/dessert) - US $25
$3 supplemental charge for tempura prawns`;
          case 'buffet':
            return `Buffet - USD$30`;
          case 'kiddie':
            return `Kiddies' buffet - USD$15`;
          default:
            return '';
        }
      }

      function loadImageAsBase64(url, callback) {
        const img = new Image();
        img.setAttribute('crossOrigin', 'anonymous');
        img.onload = function () {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL('image/png');
          callback(dataURL, img.width, img.height);
        };
        img.onerror = function () {
          console.error("Failed to load image for PDF:", url);
          callback(null, 0, 0);
        };
        img.src = url;
      }

      // ---------------- PDF Generation Section ----------------
      downloadPdfButton.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yPos = 10; // Starting Y position for PDF content

        const desiredWidth = 50; // Logo width in mm

        loadImageAsBase64('./logo.png', function (base64Logo, imgWidth, imgHeight) {
          if (base64Logo && imgWidth > 0 && imgHeight > 0) {
            const aspectRatio = imgHeight / imgWidth;
            const calculatedHeight = desiredWidth * aspectRatio;
            doc.addImage(
              base64Logo,
              'PNG',
              (doc.internal.pageSize.getWidth() - desiredWidth) / 2,
              yPos,
              desiredWidth,
              calculatedHeight
            );
            // Spacing between the logo and the following text (adjust value here)
            yPos += calculatedHeight + 7;
          }

          // --- Menu Info Section ---
          const menuInfo = getMenuInfoText();
          if (menuInfo) {
            doc.setFont('Times', 'italic');
            doc.setFontSize(11);
            const splitText = doc.splitTextToSize(menuInfo, 180);
            // Center the menu info text and set line spacing via lineHeightFactor
            doc.text(splitText, doc.internal.pageSize.getWidth() / 2, yPos, {
              align: 'center',
              lineHeightFactor: 1.2
            });
            // Spacing after the menu info text (adjust multiplier here)
            yPos += (splitText.length * 6);

            // Extra spacing for buffet/kiddie menus (adjust value here)
            if (menuType.value === 'buffet' || menuType.value === 'kiddie') {
              yPos += 7;
            }
          }

          // --- Courses, Dishes, and Descriptions ---
          Object.keys(selectedDishes).forEach(courseType => {
            const dishes = selectedDishes[courseType].filter(d => d);
            const customChosen = customDishes.filter(cd => cd.course === courseType);
            if (dishes.length > 0 || customChosen.length > 0) {
              // For a 3-course menu, add a course heading for standard courses
              const is3Course = (menuType.value === '3course');
              const isStandardCourse = ['starters', 'mains', 'desserts'].includes(courseType);
              if (is3Course && isStandardCourse) {
                doc.setFont('Times', 'bold');
                doc.setFontSize(12);
                doc.text(`${courseType.toUpperCase()}`, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after the course heading (adjust value here)
                yPos += 8;
              }

              // Standard Dishes
              dishes.forEach(dish => {
                doc.setFont('Times', 'normal');
                doc.setFontSize(11);
                // Dish name (uppercase, centered)
                doc.text(`${dish.name.toUpperCase()}`, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after dish name (adjust value here)
                yPos += 5;

                doc.setFont('Times', 'italic');
                doc.setFontSize(11);
                // Dish description (lowercase, centered)
                doc.text(`${dish.description.toLowerCase()}`, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after dish description (adjust value here)
                yPos += 7;
              });

              // Custom Dishes
              customChosen.forEach(dish => {
                doc.setFont('Times', 'normal');
                doc.setFontSize(11);
                // Custom dish name
                doc.text(`${dish.name.toUpperCase()}`, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after custom dish name (adjust value here)
                yPos += 5;

                doc.setFont('Times', 'italic');
                doc.setFontSize(11);
                // Custom dish description
                doc.text(`${dish.description.toLowerCase()}`, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after custom dish description (adjust value here)
                yPos += 7;
              });

              // Add a note after the 'mains' course if applicable
              if (courseType === 'mains') {
                doc.setFont('Times', 'italic','bold');
                doc.setFontSize(11);
                const mainsNoteText =
`*Mains are served with the starch of your choice (fries, mashed
potatoes, rice, or sadza) and vegetables or garden salad*`;
                const splitNote = doc.splitTextToSize(mainsNoteText, 180);
                doc.text(splitNote, doc.internal.pageSize.getWidth() / 2, yPos, {
                  align: 'center'
                });
                // Spacing after the mains note (adjust multiplier here)
                yPos += splitNote.length * 6;
                // Additional spacing before the next course (adjust value here)
                yPos += 3;
              }
            }
          });

          // --- Filename and Save PDF ---
          const today = new Date();
          const dd = String(today.getDate()).padStart(2, '0');
          const mm = String(today.getMonth() + 1).padStart(2, '0');
          const formattedDate = `${dd}-${mm}`;
          let menuTypeName = '';
          switch (menuType.value) {
            case '3course':
              menuTypeName = '3-Course Menu';
              break;
            case 'buffet':
              menuTypeName = 'Buffet Menu';
              break;
            case 'kiddie':
              menuTypeName = 'Kiddie Menu';
              break;
            default:
              menuTypeName = 'Menu';
          }
          const filename = `${menuTypeName} ${formattedDate}.pdf`;
          doc.save(filename);
        });
      });
      // ---------------- End PDF Generation Section ----------------

      function openAllDishesModal() {
        allDishesModal.style.display = 'block';
      }
      function closeAllDishes() {
        allDishesModal.style.display = 'none';
      }
      closeAllDishesModal.addEventListener('click', closeAllDishes);
      window.addEventListener('click', (event) => {
        if (event.target === allDishesModal) {
          closeAllDishes();
        }
      });
      function populateAllDishes() {
        if (!dishesByType || typeof dishesByType !== 'object') return;
        let htmlOutput = '';
        Object.keys(dishesByType).forEach(typeKey => {
          const dishArray = dishesByType[typeKey];
          if (!Array.isArray(dishArray)) return;
          htmlOutput += `<h3>${typeKey.toUpperCase()}</h3>`;
          dishArray.forEach(dish => {
            htmlOutput += `
              <p>
                <strong>${dish.name}</strong><br>
                <em>${dish.description || ''}</em>
              </p>`;
          });
        });
        allDishesList.innerHTML = htmlOutput;
      }
      showPage('page1');
    });
  </script>
</body>
</html>
