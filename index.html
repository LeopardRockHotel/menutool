<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leopard Rock Menu Selector Tool</title>
  
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@300;400;600&display=swap"
    rel="stylesheet"
  >
  
  <!-- Choices.js CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
  >

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <style>
    /* ================= Global Spacing Settings ================= */
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #eef2f5;
      margin: 0; /* Overall page margin */
      padding: 0; /* Overall page padding */
      color: #333;
      line-height: 1.6; /* Global line spacing (adjust for text readability) */
    }
    .container {
      max-width: 900px;
      margin: 50px auto; /* Outer margin: top-bottom=50px, auto left-right */
      padding: 30px;    /* Inner padding for container */
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    /* ================= Progress Bar Spacing ================= */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px; /* Space below progress bar */
    }
    .progress-bar .step {
      width: 40px;
      height: 40px;
      background: #ddd;
      border-radius: 50%;
      line-height: 40px; /* Centers the number vertically */
      text-align: center;
      font-weight: bold;
      color: #fff;
    }
    .progress-bar .step.active {
      background: #007bff;
    }

    /* ================= Heading Spacing ================= */
    h1 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.8rem;
      text-align: center;
      color: #333;
      margin: 30px 0; /* Top and bottom margin for h1 */
    }
    h2 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.4rem;
      color: #333;
      margin-bottom: 20px; /* Space below h2 */
    }
    h3 {
      font-family: 'Roboto', sans-serif;
      font-size: 1.6rem;
      color: #333;
      margin-bottom: 15px; /* Space below h3 */
    }

    /* ================= Fieldset & Legend Spacing ================= */
    fieldset {
      border: none;
      padding: 0; /* Remove default padding */
      margin: 0 0 30px; /* Space below each fieldset */
    }
    legend {
      font-size: 1.3rem;
      margin-bottom: 10px; /* Space below legend text */
      color: #007bff;
      font-weight: bold;
    }

    /* ================= Form Element Spacing ================= */
    .menu-section {
      margin-bottom: 30px; /* Space between different form sections */
    }
    label {
      display: block;
      margin: 12px 0 6px; /* Top, right/left, and bottom margins for labels */
      font-weight: 500;
    }
    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px; /* Inner padding for form elements */
      margin-bottom: 12px; /* Space below each input element */
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    /* ================= Button Spacing ================= */
    button {
      padding: 14px 28px; /* Vertical and horizontal padding for buttons */
      font-size: 1rem;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin-left: 10px; /* Space to the left of each button */
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
      transform: translateY(-2px); /* Slight lift on hover */
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px; /* Space above navigation buttons */
      flex-wrap: wrap;
    }
    .navigation button {
      margin-top: 10px; /* Space above each navigation button if wrapping */
    }

    /* ================= Page Visibility ================= */
    .hidden { display: none; }
    .page { display: none; }
    .page:not(.hidden) { display: block; }

    /* ================= Preview Pane Spacing ================= */
    #previewPane {
      background-color: #f7f7f7;
      border: 1px solid #ccc;
      padding: 15px; /* Inner padding for preview pane */
      margin-top: 20px; /* Space above preview pane */
      max-height: 400px;
      overflow-y: auto;
      font-family: "Courier New", monospace;
      font-size: 0.9rem;
      color: #444;
    }
    #previewPane p {
      margin: 1em 0; /* Margin for paragraphs within preview pane */
      font-family: inherit;
      font-size: inherit;
      font-weight: normal;
      text-transform: none;
      text-align: left;
    }
    /* Inline editing styling spacing */
    .editable {
      border-bottom: 1px dashed #007bff;
      padding: 2px; /* Padding around editable text */
    }

    /* ================= Dish Item Spacing in Preview ================= */
    .dish-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px; /* Space between individual dish items */
    }

    /* ================= Logo Spacing ================= */
    .logo {
      display: block;
      margin: 0 auto 20px; /* Center logo; 20px space below */
      max-width: 200px;
      height: auto;
    }

    /* ================= Modal Spacing ================= */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; 
      z-index: 9999; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5); /* Background overlay */
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; /* Modal vertical margin as 10% of viewport, center horizontally */
      padding: 20px;    /* Inner padding for modal */
      border-radius: 8px;
      width: 80%;       /* Modal width */
      max-width: 600px;
      position: relative;
    }
    .modal .closeBtn {
      position: absolute;
      top: 10px;   /* Space from top of modal content */
      right: 15px; /* Space from right edge */
      font-size: 1.4rem;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .modal .closeBtn:hover {
      color: #000;
    }
    #allDishesList p {
      margin: 8px 0; /* Margin for each dish item in modal */
    }
  </style>
</head>
<body>
  <noscript>
    <p style="color: red; text-align: center;">This app requires JavaScript to function. Please enable JavaScript in your browser.</p>
  </noscript>

  <div class="container">
    <!-- Logo -->
    <img src="./logo.png" alt="Leopard Rock Logo" class="logo" id="interfaceLogo">
    
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="step active" data-step="1">1</div>
      <div class="step" data-step="2">2</div>
      <div class="step" data-step="3">3</div>
      <div class="step" data-step="4">4</div>
    </div>

    <h1>Leopard Rock Menu Selector Tool</h1>

    <!-- Page 1: Menu Type Selection -->
    <div id="page1" class="page">
      <fieldset class="menu-section">
        <legend>Select Menu Type:</legend>
        <div style="display: flex; align-items: center; flex-wrap: wrap;">
          <select id="menuType" class="searchable-select">
            <option value="">--Select--</option>
            <option value="3course">3-Course Menu</option>
            <option value="buffet">Buffet - USD$30</option>
            <option value="kiddie">Kiddies' buffet - USD$15</option>
          </select>
          <button id="refreshBtn">Refresh</button>
          <button id="viewAllDishesBtn">View All Dishes</button>
        </div>
      </fieldset>

      <!-- Customize Menu Description Section -->
      <button id="customizeMenuDescBtn">Customize Menu Description</button>
      <div id="customMenuDescContainer" class="hidden" style="margin-top:10px;">
        <label for="customMenuDescInput">Enter Custom Menu Description:</label>
        <textarea id="customMenuDescInput" rows="3" placeholder="e.g. Valentine's Day Menu: A romantic selection of dishes to celebrate love." style="width:100%;"></textarea>
        <button id="saveCustomDescBtn" style="margin-top:5px;">Save Description</button>
      </div>

      <fieldset id="dishCounts" class="menu-section hidden">
        <legend>Enter Dish Counts:</legend>
        <div id="courseCounts">
          <!-- Inputs will change based on menu type selection -->
        </div>
      </fieldset>

      <div class="navigation">
        <div></div> <!-- Empty div for alignment -->
        <button id="toPage2" disabled>Next</button>
        <!-- Random Menu Generator button appears after a menu type is selected -->
        <button id="randomMenuBtn">Random Menu</button>
      </div>
    </div>

    <!-- Page 2: Course Selection -->
    <div id="page2" class="page hidden">
      <h2>Course Selection</h2>
      <div id="courseSelectionArea">
        <!-- Dynamic course selection UI will go here -->
      </div>
      <div class="navigation">
        <button id="backToPage1">Back</button>
        <button id="toPage3" disabled>Next</button>
      </div>
    </div>

    <!-- Page 3: Custom Dish Input -->
    <div id="page3" class="page hidden">
      <fieldset id="customDishContainer" class="menu-section">
        <legend>Custom Dish</legend>
        <label for="customDishCourse">Select Course:</label>
        <select id="customDishCourse" class="searchable-select">
          <option value="">--Select Course--</option>
          <option value="starters">Starter</option>
          <option value="mains">Main</option>
          <option value="desserts">Dessert</option>
          <option value="buffet">Buffet Dish</option>
          <option value="kiddie">Kiddie Dish</option>
        </select>

        <label for="customDishName">Dish Name:</label>
        <input type="text" id="customDishName" placeholder="Enter dish name">

        <label for="customDishDescription">Description:</label>
        <input type="text" id="customDishDescription" placeholder="Enter dish description">

        <button id="addCustomDish" disabled>Add Custom Dish</button>
      </fieldset>
      <div class="navigation">
        <button id="backToPage2">Back</button>
        <div>
          <button id="skipCustomDish">Skip</button>
          <button id="toPage4">Next</button>
        </div>
      </div>
    </div>

    <!-- Page 4: Preview and Download -->
    <div id="page4" class="page hidden">
      <h2>Preview Menu</h2>
      <div id="previewPane"></div>
      <div class="navigation">
        <button id="backToPage3">Back</button>
        <div>
          <button id="backToBeginning">Back to Beginning</button>
          <button id="downloadPdf">Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== MODAL FOR ALL DISHES ======== -->
  <div id="allDishesModal" class="modal">
    <div class="modal-content">
      <span class="closeBtn" id="closeAllDishesModal">&times;</span>
      <h2>All Dishes</h2>
      <div id="allDishesList">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>
  <!-- ====================================== -->

  <!-- Choices.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  
  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Global flag to indicate random generation should occur
      let randomMenuFlag = false;

      // ======== Refresh Button ========
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.addEventListener('click', () => {
        location.reload();
      });

      // ======= DOM Elements =======
      const menuType = document.getElementById('menuType');
      const dishCounts = document.getElementById('dishCounts');
      const courseCounts = document.getElementById('courseCounts');
      const toPage2Button = document.getElementById('toPage2');
      const backToPage1Button = document.getElementById('backToPage1');
      const courseSelectionArea = document.getElementById('courseSelectionArea');
      const toPage3Button = document.getElementById('toPage3');
      const backToPage2Button = document.getElementById('backToPage2');
      const toPage4Button = document.getElementById('toPage4');
      const skipCustomDishButton = document.getElementById('skipCustomDish');
      const previewPane = document.getElementById('previewPane');
      const backToPage3Button = document.getElementById('backToPage3');
      const backToBeginningButton = document.getElementById('backToBeginning');
      const downloadPdfButton = document.getElementById('downloadPdf');
      const randomMenuBtn = document.getElementById('randomMenuBtn'); // Random Menu Generator button

      // For "View All Dishes" modal
      const viewAllDishesBtn = document.getElementById('viewAllDishesBtn');
      const allDishesModal = document.getElementById('allDishesModal');
      const closeAllDishesModal = document.getElementById('closeAllDishesModal');
      const allDishesList = document.getElementById('allDishesList');

      // For custom dish
      const addCustomDishButton = document.getElementById('addCustomDish');
      const customDishCourse = document.getElementById('customDishCourse');
      const customDishName = document.getElementById('customDishName');
      const customDishDescription = document.getElementById('customDishDescription');

      // For custom menu description on Page 1
      const customizeMenuDescBtn = document.getElementById('customizeMenuDescBtn');
      const customMenuDescContainer = document.getElementById('customMenuDescContainer');
      const saveCustomDescBtn = document.getElementById('saveCustomDescBtn');
      const customMenuDescInput = document.getElementById('customMenuDescInput');

      // ======= Data Structures =======
      let selectedDishes = {
        starters: [],
        mains: [],
        desserts: [],
        buffet: [],
        kiddie: []
      };
      let customDishes = []; // each item: { course, name, description }
      let dishesByType = {};
      let customMenuDescription = ""; // For storing custom menu description

      let courseChoiceInstances = {}; // For each course, an array of Choices instances
      let customCourseChoices;       // Single Choices instance for customDishCourse

      // ======= Fetch Dishes Data from Google Sheets CSV =======
      const sheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQE6yAJLO14sFl_di8pSMHF3WW0PDSlyjsn1lPrukpMgVbXx_aCZkoIPTZrcLayPLNvjTcuyBOFyzne/pub?gid=541609837&single=true&output=csv';

      fetch(sheetCsvUrl)
        .then(response => {
          if (!response.ok) throw new Error("Failed to load Google Sheets CSV");
          return response.text();
        })
        .then(csvText => {
          const parsed = Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
          });
          // Build dishesByType object matching your JSON structure
          dishesByType = {}; 
          parsed. data.forEach(row => {
            const course = row.course?.toLowerCase()?.trim();
            const name = row.name?.trim();
            const description = row.description?.trim() || '';

            if (!course || !name) return; // skip incomplete rows

            if (!dishesByType[course]) {
              dishesByType[course] = [];
            }
            dishesByType[course].push({ name, description });
          });

          console.log("Dishes loaded from Google Sheets:", dishesByType);

          //
